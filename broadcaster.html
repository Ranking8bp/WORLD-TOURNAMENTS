<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ðŸ“¹ Soy el streamer â€“ Compartir pantalla</title>

<style>
  body {
    margin: 0;
    padding: 20px;
    font-family: system-ui, sans-serif;
    background: #050712;
    color: white;
    text-align: center;
  }

  h1 {
    margin-top: 20px;
    font-size: 26px;
  }

  button {
    margin-top: 20px;
    padding: 14px 22px;
    font-size: 16px;
    border: none;
    background: #16a34a;
    color: white;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 600;
  }

  button:active {
    transform: scale(0.97);
  }

  video {
    margin-top: 25px;
    width: 95%;
    max-width: 900px;
    background: black;
    border-radius: 12px;
    border: 1px solid #0ef2dd55;
  }
</style>
</head>

<body>
  <h1>ðŸ“º Soy el streamer â€“ Compartir pantalla</h1>
  <p>Al comenzar, todos en el ranking verÃ¡n tu pantalla en la secciÃ³n "TransmisiÃ³n en vivo".</p>

  <button id="startBtn">ðŸš€ Comenzar transmisiÃ³n</button>

  <video id="preview" autoplay playsinline></video>

<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
<script>
/* ============================================
      CONFIG
=============================================== */
const SERVER_URL = "https://streaming-torneos-server-1.onrender.com";

const socket = io(SERVER_URL);
let pc;
let screenStream;

/* ============================================
      INICIAR TRANSMISIÃ“N
=============================================== */
async function startBroadcast() {

  const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);

  if (isMobile) {
    alert(
      "âš ï¸ La transmisiÃ³n NO es compatible en celulares.\n\n" +
      "Para transmitir tu pantalla debes usar una computadora (PC o laptop)."
    );
    return;
  }

  if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
    alert(
      "âš ï¸ Tu navegador no permite compartir pantalla.\n\n" +
      "Usa Google Chrome o Microsoft Edge en PC."
    );
    return;
  }

  try {
    // Capturar pantalla
    screenStream = await navigator.mediaDevices.getDisplayMedia({
      video: true,
      audio: false
    });

    document.getElementById("preview").srcObject = screenStream;

    // Avisar al servidor que el broadcaster estÃ¡ en vivo
    socket.emit("broadcaster");

    createPeerConnection();

    screenStream.getTracks().forEach(track => {
      pc.addTrack(track, screenStream);
    });

    screenStream.getVideoTracks()[0].addEventListener("ended", () => {
      stopBroadcast();
    });

  } catch (err) {
    console.error("Error al iniciar transmisiÃ³n:", err);
    alert("No se pudo iniciar la transmisiÃ³n.");
  }
}

/* ============================================
      CREAR CONEXIÃ“N WEBRTC
=============================================== */
function createPeerConnection() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  pc.onicecandidate = event => {
    if (event.candidate) {
      socket.emit("broadcaster-candidate", event.candidate);
    }
  };
}

/* ============================================
      EVENTOS SOCKET.IO
=============================================== */
socket.on("viewer-offer", async offer => {
  if (!pc) createPeerConnection();

  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  socket.emit("broadcaster-answer", answer);
});

socket.on("viewer-candidate", candidate => {
  if (pc) {
    pc.addIceCandidate(new RTCIceCandidate(candidate));
  }
});

/* ============================================
      DETENER TRANSMISIÃ“N
=============================================== */
function stopBroadcast() {
  if (screenStream) {
    screenStream.getTracks().forEach(t => t.stop());
    screenStream = null;
  }
  if (pc) pc.close();

  alert("La transmisiÃ³n fue detenida.");
}

/* ============================================
      BOTÃ“N
=============================================== */
document.getElementById("startBtn").addEventListener("click", startBroadcast);

</script>
</body>
</html>
